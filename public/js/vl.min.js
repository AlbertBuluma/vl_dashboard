var app=angular.module("dashboard",["datatables"],function(e){e.startSymbol("<%"),e.endSymbol("%>")});app.filter("ssplit",function(){return function(e,t,r){var i=e.split(t);return i[r]}}),app.filter("slice",function(){return function(e,t){return e.slice(t)}}),app.filter("d_format",function(){return function(e){var t={1:"Jan",2:"Feb",3:"Mar",4:"Apr",5:"May",6:"Jun",7:"Jul",8:"Aug",9:"Sept",10:"Oct",11:"Nov",12:"Dec"},r=e.split("-"),i=r[0]||"",s=r[1]||"";return t[s]+" '"+i.slice(-2)}});var ctrllers={};ctrllers.DashController=function(e,t,r){var i={},s={},a={},l={},_={};r.get("../json/data.json").success(function(t){i=t.districts||{},s=t.hubs||{},a=t.age_group||{},l=t.facilities||{},e.districts_slct=i,e.hubs_slct=s,e.age_group_slct=a;var r=t.results||{};for(var n in r){var o=r[n],u=l[o.facility_id];_[n]=o,_[n].year_month=o.year+"-"+o.month,_[n].facility_name=u.name,_[n].hub_id=u.hub_id,_[n].district_id=u.district_id,_[n].district_name=i[u.district_id]}y()}),e.dateFilter=function(t){if("all"!=e.fro_date&&"all"!=e.to_date){var r={},i=e.fro_date.split("-"),s=e.to_date.split("-");r.from_year=Number(i[0]),r.from_month=Number(i[1]),r.to_year=Number(s[0]),r.to_month=Number(s[1]);var a=r.from_year<=r.to_year,l=r.from_month>r.to_month&&r.from_year<r.to_year,_=r.from_month<=r.to_month;a&&(l||_)?(console.log("duration expression passed"),n(r),h(e.filter_duration)<=12?e.filter("duration"):alert("Please choose a duration of 12 months or less")):(console.log("duration expression failing eval1="+a+" eval2"+l+" eval3"+_),console.log("fro yr="+r.from_year+" fro m"+r.from_month+" to yr="+r.to_year+" to m"+r.to_month))}};var n=function(t){e.filter_duration=[];for(var r=t.from_year;r<=t.to_year;){for(var i=r==t.from_year?t.from_month:1,s=r==t.to_year?t.to_month:12,a=i;s>=a;)e.filter_duration.push(r+"-"+a),a++;r++}};e.filter=function(t){switch(t){case"district":e.filter_districts[e.district]=i[e.district],e.district="all";break;case"hub":e.filter_hubs[e.hub]=s[e.hub],e.hub="all";break;case"age_group":e.filter_age_group[e.age_group]=a[e.age_group],e.age_group="all"}delete e.filter_districts.all,delete e.filter_hubs.all,delete e.filter_age_group.all,y()};var o=function(t){var r=h(e.filter_districts),i=h(e.filter_hubs),s=h(e.filter_age_group),a=v(t.year_month,e.filter_duration),l=e.filter_districts.hasOwnProperty(t.district_id),_=e.filter_hubs.hasOwnProperty(t.hub_id),n=e.filter_age_group.hasOwnProperty(t.age_group),o=0==r&&0==i&&0==s,u=l&&0==i&&0==s,c=l&&_&&0==s,d=l&&0==i&&n,m=l&&_&&n,f=0==r&&_&&n,p=0==r&&_&&0==s,y=0==r&&0==i&&n;return a&&(o||u||c||d||m||f||p||y)?!0:!1},u=function(t){e.samples_received+=t.samples_received,e.suppressed+=t.suppressed,e.valid_results+=t.valid_results,e.rejected_samples+=t.rejected_samples},c=function(t){e.cd4_less_than_500+=t.cd4_less_than_500,e.pmtct_option_b_plus+=t.pmtct_option_b_plus,e.children_under_15+=t.children_under_15,e.other_treatment+=t.other_treatment,e.treatment_blank_on_form+=t.treatment_blank_on_form},d=function(t){var r=e.samples_received_data.plasma[t.year_month]||0,i=e.samples_received_data.dbs[t.year_month]||0;e.samples_received_data.plasma[t.year_month]=r+(t.samples_received-t.dbs_samples),e.samples_received_data.dbs[t.year_month]=i+t.dbs_samples;var s=e.suppressed_by_duration[t.year_month]||0;e.suppressed_by_duration[t.year_month]=s+t.suppressed;var a=e.valid_res_by_duration[t.year_month]||0;e.valid_res_by_duration[t.year_month]=a+t.valid_results,m(t)},m=function(t){var r=e.rejected_by_duration.sample_quality[t.year_month]||0,i=e.rejected_by_duration.eligibility[t.year_month]||0,s=e.rejected_by_duration.incomplete_form[t.year_month]||0;e.rejected_by_duration.sample_quality[t.year_month]=r+t.sample_quality_rejections,e.rejected_by_duration.eligibility[t.year_month]=i+t.eligibility_rejections,e.rejected_by_duration.incomplete_form[t.year_month]=s+t.incomplete_form_rejections},f=function(t){e.facility_numbers[t.facility_id]=e.facility_numbers[t.facility_id]||{};var r=e.facility_numbers[t.facility_id].samples_received||0,i=e.facility_numbers[t.facility_id].valid_results||0,s=e.facility_numbers[t.facility_id].rejected_samples||0,a=e.facility_numbers[t.facility_id].suppressed||0,l=e.facility_numbers[t.facility_id].dbs_samples||0,_=e.facility_numbers[t.facility_id].total_results||0;e.facility_numbers[t.facility_id].samples_received=r+t.samples_received,e.facility_numbers[t.facility_id].valid_results=i+t.valid_results,e.facility_numbers[t.facility_id].rejected_samples=s+t.rejected_samples,e.facility_numbers[t.facility_id].suppressed=a+t.suppressed,e.facility_numbers[t.facility_id].dbs_samples=l+t.dbs_samples,e.facility_numbers[t.facility_id].total_results=_+t.total_results,e.facility_numbers[t.facility_id].name=t.facility_name},p=function(t){e.district_numbers[t.district_id]=e.district_numbers[t.district_id]||{};var r=e.district_numbers[t.district_id].samples_received||0,i=e.district_numbers[t.district_id].dbs_samples||0,s=e.district_numbers[t.district_id].total_results||0;e.district_numbers[t.district_id].samples_received=r+t.samples_received,e.district_numbers[t.district_id].dbs_samples=i+t.dbs_samples,e.district_numbers[t.district_id].total_results=s+t.total_results,e.district_numbers[t.district_id].name=t.district_name},y=function(){e.samples_received=0,e.suppressed=0,e.valid_results=0,e.rejected_samples=0,e.cd4_less_than_500=0,e.pmtct_option_b_plus=0,e.children_under_15=0,e.other_treatment=0,e.treatment_blank_on_form=0,e.samples_received_data={plasma:{},dbs:{}},e.suppressed_by_duration={},e.valid_res_by_duration={},e.rejected_by_duration={sample_quality:{},eligibility:{},incomplete_form:{}},e.facility_numbers={},e.district_numbers={};for(var t in _){var r=_[t];o(r)&&(u(r),c(r),d(r),f(r),p(r))}e.displaySamplesRecieved(),e.displaySupressionRate(),e.displayRejectionRate(),e.filters_present=h(e.filter_districts)>0||h(e.filter_hubs)>0||h(e.filter_age_group)};e.displaySamplesRecieved=function(){var t=e.samples_received_data,r=[{key:"DBS",values:[]},{key:"PLASMA",values:[]}];for(var i in t.dbs)r[0].values.push({x:b(i),y:t.dbs[i]}),r[1].values.push({x:b(i),y:t.plasma[i]});nv.addGraph(function(){var e=nv.models.multiBarChart().color(["#F44336","#607D8B"]).reduceXTicks(!1);return $("#samples_received svg").html(" "),d3.select("#samples_received svg").datum(r).transition().duration(500).call(e),e})},e.displaySupressionRate=function(){var t=[{key:"SUPRESSION RATE",color:"#607D8B",values:[]},{key:"VALID RESULTS",bar:!0,color:"#F44336",values:[]}];for(var r in e.valid_res_by_duration){var i=e.suppressed_by_duration[r]||0,s=e.valid_res_by_duration[r]||0,a=i/s*100;t[0].values.push([b(r),a]),t[1].values.push([b(r),s])}nv.addGraph(function(){var e=nv.models.linePlusBarChart().margin({right:60}).x(function(e,t){return t}).y(function(e,t){return e[1]}).focusEnable(!1);return e.xAxis.tickFormat(function(e){return t[0].values[e]&&t[0].values[e][0]||" "}),e.lines.forceY([0,100]),$("#supression_rate svg").html(" "),d3.select("#supression_rate svg").datum(t).transition().duration(500).call(e),e})},e.displayRejectionRate=function(){var t=e.rejected_by_duration,r=[{key:"SAMPLE QUALITY",values:[]},{key:"INCOMPLETE FORM",values:[]},{key:"ELIGIBILITY",values:[]}];for(var i in t.sample_quality){var s=t.sample_quality[i]+t.incomplete_form[i]+t.eligibility[i],a=t.sample_quality[i]/s*100,l=t.incomplete_form[i]/s*100,_=t.eligibility[i]/s*100;r[0].values.push({x:b(i),y:a}),r[1].values.push({x:b(i),y:l}),r[2].values.push({x:b(i),y:_})}nv.addGraph(function(){var e=nv.models.multiBarChart().reduceXTicks(!1).stacked(!0).color(["#607D8B","#B1DEDA","#F44336"]);return $("#rejection_rate svg").html(" "),d3.select("#rejection_rate svg").datum(r).transition().duration(500).call(e),e})},e.compare=function(e,t,r){return function(i){return"eq"==t?i[e]==r:"ne"==t?i[e]!=r:"gt"==t?i[e]>r:"lt"==t?i[e]<r:"ge"==t?i[e]>r||i[e]==r:"le"==t?i[e]<r||i[e]==r:!1}},e.removeTag=function(t,r){switch(t){case"district":delete e.filter_districts[r];break;case"hub":delete e.filter_hubs[r];break;case"age_group":delete e.filter_age_group[r]}e.filter(t)},e.clearAllFilters=function(){e.filter_districts={},e.filter_hubs={},e.filter_age_group={},y()},e.empty=function(e,t){return function(r){switch(r[e]){case"":case 0:case"0":case null:case!1:case"undefined"==typeof this:return"no"==t?!1:!0;default:return"no"==t?!0:!1}}},e.nana=function(){1==e.show_fclties?($("#d_shw").attr("class","active"),$("#f_shw").attr("class",""),e.show_fclties=!1):($("#f_shw").attr("class","active"),$("#d_shw").attr("class",""),e.show_fclties=!0)};var v=function(e,t){var r=!1;for(var i in t)e==t[i]&&(r=!0);return r},b=function(t){var r=t.split("-"),i=r[0],s=r[1];return e.month_labels[s]+" '"+i.slice(-2)},h=function(e){return Object.keys(e).length}},app.controller(ctrllers);